<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philly Thrive Map</title>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
<meta http-equiv="Content-Language" content="en">
<meta name="google" content="notranslate">


    <style>
        /* Map Styling */
        html, body { margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        #map { width: 100%; height: 100vh; }
        .popup-content img { max-width: 100%; height: auto; border-radius: 5px; }
        .carousel-container { text-align: center; }
        .carousel-slide { display: none; max-width: 100%; max-height: 300px; object-fit: contain; }
        .carousel-slide.active { display: block; }
        .prev, .next { cursor: pointer; }
		
		.leaflet-popup-content {
    max-width: 300px;
}
.popup-content h2 {
    font-size: 18px;
    margin-bottom: 5px;
}

.legend {
    background: white;
    padding: 10px;
    line-height: 18px;
    color: #555;
    border-radius: 5px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
}
.legend i {
    width: 10px;
    height: 10px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
}

.legend img {
    border-radius: 3px;
    box-shadow: 0 0 2px rgba(0,0,0,0.2);
}

.default-circle {
    background: transparent;
}


    </style>
</head>
<body>
    <div id="map"></div>
<script>
// Define different basemaps


var cartoVoyagerNoLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19
});


var googleStreets = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
    attribution: '&copy; Google Maps'
});

var basemaps = {
    "Google Streets": googleStreets,
    "Esri Community Maps":  L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: '&copy; Esri, Community Maps Contributors' }),
    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }),
    "Carto Positron": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB' }),
    "Esri World Imagery": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' }),
    "Esri Topographic": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' }),
    "Carto Dark Matter": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB'  }),
	"Carto Voyager (No Labels)": cartoVoyagerNoLabels

};

var bounds = L.latLngBounds(
    [39.88803551186901, -75.24100534247376],  // Southwest corner
    [39.96163027738092, -75.1591196365127]   // Northeast corner
);

var map = L.map('map', {
    layers: [cartoVoyagerNoLabels],
    maxBounds: bounds,
    maxBoundsViscosity: 0.01,
    minZoom: 12,
    maxZoom: 18
});

map.fitBounds(bounds);  // Automatically centers and zooms to fit bounds


var imageUrl = 'jbrew1934.png';  // 
var imageBounds = [
    [39.903605, -75.235695],  // Bottom-left (Lat, Lon)
    [39.965321, -75.121852]   // Top-right (Lat, Lon)
];

// Overlay the historic map onto the Leaflet map
// var historicMap = L.imageOverlay(imageUrl, imageBounds, { }).addTo(map);
var historicMap = L.imageOverlay(imageUrl, imageBounds, {});


var overlays = {
   
    "1934 Historic Map": historicMap
};

// Add basemap selection control
L.control.layers(basemaps, overlays, { position: "topleft" }).addTo(map);
// Define the georeferenced image and its bounds


// Define category colors
const categoryColors = {
    "Parks and Green Spaces": "limegreen",
    "Housing": "orange",
    "Businesses": "sienna",
    "Schools": "gold",
    "Community Buildings": "lightblue",
    "Environmental Impacts": "crimson",
    "Streets": "gray",
    "Uncategorized Site": "#d3dce6"
};

const categoryOrder = [
    "Parks and Green Spaces",
    "Housing",
    "Businesses",
    "Schools",
    "Community Buildings",
    "Environmental Impacts",
    "Streets",
	"Uncategorized Site"
];



var legend = L.control({ position: "bottomright" });

legend.onAdd = function(map) {
    var div = L.DomUtil.create("div", "legend");
    div.innerHTML += "<h4>Legend</h4>";

    for (let key in categoryColors) {
        // Check if icon is available for this category
        if (categoryIcons[key]) {
            div.innerHTML += `<img src="${categoryIcons[key]}" 
                                   style="width: 20px; height: 20px; vertical-align: middle; margin-right: 6px;"> 
                              ${key}<br>`;
        } else {
            // Fallback to color swatch
            div.innerHTML += `<i style="background:${categoryColors[key]}; 
                                         width: 12px; height: 12px; 
                                         display: inline-block; margin-right: 5px;"></i> ${key}<br>`;
        }
    }

    return div;
};


// Fetch data and place markers
var apiUrl = "https://script.google.com/macros/s/AKfycbzyrIcLZaFyYhwUGviH9bYw5GOzKGooPomy2arJmi2D4V-G8-QF-yME-gqcnaSHUeDYVA/exec";

var markersArray = [];

function addMarkersInBatches(data, batchSize = 50, delay = 50) {
    let i = 0;

    function processBatch() {
        let batch = data.slice(i, i + batchSize);
batch.forEach(location => {
    if (!location.X || !location.Y) return;

    // ‚úÖ First define the category
	let category = location["Category/Layer"] ? location["Category/Layer"].trim() : "Uncategorized Site";
    let markerColor = categoryColors[category] || categoryColors["Default"];

    // ‚úÖ Then store the icon (once per category)
    if (!categoryIcons[category] && location["Marker Icon"] && location["Marker Icon"].includes("drive.google.com")) {
        categoryIcons[category] = convertGoogleDriveImageLink(location["Marker Icon"]);
    }

    // Define the marker icon
    let customIcon = location["Marker Icon"] && location["Marker Icon"].includes("drive.google.com")
        ? L.icon({
            iconUrl: convertGoogleDriveImageLink(location["Marker Icon"]),
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        })
        : L.divIcon({ 
            className: "default-circle", 
            html: `<div style="background:${markerColor}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid #333;"></div>` 
        });

    let marker = L.marker([parseFloat(location.X), parseFloat(location.Y)], { icon: customIcon });

    marker.on('click', function() {
        showPopup(location);
    });

    markersArray.push(marker);
});


        i += batchSize;
        if (i < data.length) {
            setTimeout(processBatch, delay);
        } else {
            var markerLayer = L.layerGroup(markersArray);
            map.addLayer(markerLayer);
			legend.addTo(map);

        }
    }

    processBatch();
}


const categoryIcons = {};

fetch(apiUrl)
    .then(response => response.json())
    .then(data => addMarkersInBatches(data))
    .catch(error => console.error("Error fetching data:", error));

function showPopup(location) {
    let content = `<h2>${location.Name}</h2>`;
    if (location.Address) content += `<p><strong>Address:</strong> ${location.Address}</p>`;

    // **Ensure a unique ID for each popup**
    let popupId = location.Name.replace(/\s/g, '');

let images = Object.keys(location)
    .filter(key => key.startsWith('Image') && location[key]);

if (images.length > 0) {
    content += `<div id="popup-${popupId}" class="carousel-container">
                    <p class="image-counter">Image 1 of ${images.length}</p>
                    <button class="fullscreen-btn" onclick="viewFullscreen()">üîç</button>`;

images.forEach((img, index) => {
    let imgSrc = location[img]; // Default URL from Google Sheets

    // ‚úÖ Ensure only valid Google Drive URLs are converted
    if (location[img] && location[img].includes("drive.google.com")) {
        imgSrc = convertGoogleDriveImageLink(location[img]);
    }

    content += `<img class="carousel-slide ${index === 0 ? 'active' : ''}" 
                 src="${imgSrc}" 
                 onclick="viewFullscreen(this)"
                 onerror="this.onerror=null; this.style.display='none'; console.error('Image failed:', this.src);">`;
});


    content += `<button class="prev" onclick="changeSlide(-1, 'popup-${popupId}')">&#10094;</button>`;
    content += `<button class="next" onclick="changeSlide(1, 'popup-${popupId}')">&#10095;</button>`;
    content += `</div>`;
} else {
    content += `<p>No images available</p>`;
}


    // **Handling Audio from GitHub**
    let audioURL = location["Audio"]; // Read audio column from Google Sheets
    if (audioURL && audioURL.includes("github.com")) {
        content += `<h3>Audio Recording:</h3>
                    <audio controls>
                        <source src="${audioURL}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>`;
    }

    L.popup().setLatLng([location.X, location.Y]).setContent(content).openOn(map);
}


function convertGoogleDriveImageLink(url) {
    let match = url.match(/(?:\/d\/|id=)([a-zA-Z0-9-_]+)/);
    if (match) {
        let fileId = match[1];
        return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`; // ‚úÖ Ensures proper embedding
    }
    return url;
}

function changeSlide(n, popupId) {
    console.log("Popup ID:", popupId);  // Debugging: Check the popupId
    let popup = document.getElementById(popupId);

    if (!popup) {
        console.error(`Popup with ID popup-${popupId} not found!`);
        return;
    }

    let slides = popup.querySelectorAll(".carousel-slide");
    let counter = popup.querySelector(".image-counter");

    console.log("Slides found:", slides.length);  // Debugging: Check how many slides exist
    if (!slides.length) {
        console.error("No slides found inside popup.");
        return;
    }

    let activeIndex = Array.from(slides).findIndex(slide => slide.classList.contains("active"));
    console.log("Active slide index before:", activeIndex);

    let newIndex = (activeIndex + n + slides.length) % slides.length;
    console.log("New active slide index:", newIndex);

    slides.forEach((slide, i) => slide.classList.toggle("active", i === newIndex));

    if (counter) {
        counter.textContent = `Image ${newIndex + 1} of ${slides.length}`;
    }
}


function viewFullscreen(img) {
    if (img && img.src) {
        window.open(img.src, "_blank");
    }
}



</script>

</body>
</html>
